<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>How to use voice with Sleepy Discord</title>
    <link rel="icon" href="images/title-icon.png" type="image/png">
    <meta property="og:title" content="Sleepy Discord">
    <meta name="description" content="C++ library for Discord">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>

    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>

    <link rel="stylesheet" type="text/css" href="stylesheets/oldnormalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
	  <link rel="stylesheet" type="text/css" href="stylesheets/Stylesheet.css" media="screen">
	  <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>

  <body class="voice" data-languages="[]">

  <section class="main">
    <a href="#" id="nav-button">
      <span>
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="tocify-wrapper">
        <div class="search">
          <input type="text" name="search" id="input-search" placeholder="Search Documentation" style = "border: none;" class="btn">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
        <li><a href="faq">FAQ</a></li>
        <li><a href="https://github.com/yourWaifu/sleepy-discord">Sleepy Discord</a> is maintained by</li>
        <li><a href="https://github.com/yourWaifu">yourWaifu</a>.</li>
            <li><a href='https://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    </section>
    <div class="page-wrapper">
    
     <section class="page-header">
		  <a href="." class="btn">
		  	<h1 class="project-name">Sleepy Discord</h1>
		  </a>
      <a href="https://github.com/yourWaifu/sleepy-discord" class="btn">View on GitHub</a>
	  </section>

<section class="main">
	<div class="aplha-below"></div>
      <div class="dark-box"></div>
      <div class="content">
        <p><a href="documentation.html">â®Œ Go back to documentation</a></p>

<h1 id="create-applications-with-voice-with-sleepy-discord">Create Applications with Voice with Sleepy Discord</h1>

<p>Sleepy Discord can allow applications to use voice channels. This allows for things such as music players or whatever you came up with that can take advantage of Discord&rsquo;s voice chat.</p>

<h2 id="connect-to-a-voice-channel">Connect to a Voice Channel</h2>
<pre class="highlight cpp tab-cpp"><code><span class="n">myClient</span><span class="o">-&gt;</span><span class="n">connectToVoiceChannel</span><span class="p">(</span><span class="s">"channelID"</span><span class="p">,</span> <span class="s">"serverID"</span><span class="p">);</span>
</code></pre><pre class="highlight cpp tab-cpp"><code><span class="n">myClient</span><span class="o">-&gt;</span><span class="n">connectToVoiceChannel</span><span class="p">(</span><span class="n">myClient</span><span class="o">-&gt;</span><span class="n">createContext</span><span class="p">(</span><span class="s">"channelID"</span><span class="p">,</span> <span class="s">"serverID"</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">));</span>
</code></pre>
<p>There are a few ways to connect to a voice channel but the first example, calling <a href="documentation.html#connecttovoicechannel">BaseDiscordClient::connectToVoiceChannel</a> with just a <code class="prettyprint">channelID</code> and <code class="prettyprint">serverID</code>, is the simplest.</p>

<h4 id="related-articles">Related Articles</h4>

<p><a href="documentation.html#connecttovoicechannel">BaseDiscordClient::connectToVoiceChannel</a>
<a href="documentation.html#voicecontext">VoiceContext</a>
<a href="documentation.html#createContext">BaseDiscordClient::createContext</a></p>

<h2 id="event-handling">Event Handling</h2>
<pre class="highlight cpp tab-cpp"><code><span class="k">class</span> <span class="nc">VoiceEventHandler</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">BaseVoiceEventHandler</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">VoiceEventHandler</span><span class="p">()</span> <span class="p">{}</span>
    <span class="kt">void</span> <span class="n">onReady</span><span class="p">(</span><span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">VoiceConnection</span><span class="o">&amp;</span> <span class="n">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*Do stuff when ready to start sending audio*/</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">VoiceEventHandler</span> <span class="n">voiceEventHandler</span><span class="p">;</span>

<span class="c1">//somewhere else in your code
</span><span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">VoiceContext</span><span class="o">&amp;</span> <span class="n">context</span> <span class="o">=</span> <span class="n">myClient</span><span class="o">-&gt;</span><span class="n">createContext</span><span class="p">(</span><span class="s">"channelID"</span><span class="p">,</span> <span class="s">"serverID"</span><span class="p">,</span> <span class="n">voiceEventHandler</span><span class="p">);</span>
<span class="c1">//or
</span><span class="n">context</span><span class="p">.</span><span class="n">setVoiceHandler</span><span class="p">(</span><span class="n">voiceEventHandler</span><span class="p">);</span>
</code></pre>
<p>Event handling is done in a separated inherited object, a VoiceEventHandler, creating one is done by simply creating a class that inherits traits from <a href="documentation.html#basevoiceeventhandler">BaseVoiceEventHandler</a>.</p>

<p>During runtime, a reference of or pointer to your VoiceEventHandler will need to be given to a <a href="documentation.html#voicecontext">VoiceContext</a>. This object should live longer then the VoiceContexts that hold the pointer to your VoiceEventHandler (VoiceContexts are destroyed after closing the connection). Not doing so will cause the client to crash.</p>

<p>One useful event being the <a href="#">BaseVoiceEventHandler::onReady</a> event. This is called when the client has finished connecting and is ready to start sending data to one of Discord&rsquo;s voice servers. Some of you maybe confused as to why this is done via a callback and asking &ldquo;Shouldn&rsquo;t the client be ready after calling <a href="documentation.html#connecttovoicechannel">BaseDiscordClient::connectToVoiceChannel</a>?&rdquo;. This is because, there&rsquo;s a number of steps involved with getting ready that happen outside the function call.</p>

<h4 id="related-articles">Related Articles</h4>

<p><a href="documentation.html#basevoiceeventhandler">BaseVoiceEventHandler</a>
<a href="#">BaseVoiceEventHandler::onReady</a>
<a href="documentation.html#setvoicehandler">VoiceContext::setVoiceHandler</a>
<a href="documentation.html#voiceconnection">VoiceConnection</a></p>

<h2 id="linking-the-needed-libraries">Linking the needed libraries</h2>

<p>You&rsquo;ll need those if you want to send or receive audio.</p>

<h3 id="sodium">Sodium</h3>

<h3 id="opus">Opus</h3>

<h3 id="a-udp-library">A UDP library</h3>

<h2 id="sending-audio">Sending Audio</h2>

<p>Once connected to a voice server with all needed library linked, we can begin sending Audio to over to Discord. To do this, create a <a href="documentation.html#audiosource">AudioSource</a>, and then call <a href="documentation.html#startspeaking">VoiceConnection::startSpeaking</a>.</p>

<h3 id="audio-sources">Audio Sources</h3>
<pre class="highlight cpp tab-cpp"><code><span class="k">struct</span> <span class="n">Music</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AudioSource</span><span class="o">&lt;</span><span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AUDIO_POINTER</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">Music</span><span class="p">()</span> <span class="o">:</span> <span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AudioSource</span><span class="o">&lt;</span><span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AUDIO_POINTER</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">File</span> <span class="n">musicFile</span><span class="p">(</span><span class="s">"music.raw"</span><span class="p">);</span>
        <span class="n">musicLength</span> <span class="o">=</span> <span class="n">musicFile</span><span class="p">.</span><span class="n">getSize</span><span class="p">()</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="kt">int16_t</span><span class="p">;</span>
        <span class="n">music</span> <span class="o">=</span> <span class="n">musicFile</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">constexpr</span> <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">isOpusEncoded</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="p">}</span> <span class="c1">//optional, will be false by default
</span>    <span class="kt">void</span> <span class="n">read</span><span class="p">(</span><span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AudioTransmissionDetails</span><span class="o">&amp;</span> <span class="n">details</span><span class="p">,</span> <span class="kt">int16_t</span><span class="o">*&amp;</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&amp;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">music</span><span class="p">[</span><span class="n">progress</span><span class="p">];</span>
        <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">musicLength</span> <span class="o">-</span> <span class="n">progress</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">details</span><span class="p">.</span><span class="n">proposedLength</span><span class="p">()</span> <span class="o">?</span> <span class="n">details</span><span class="p">.</span><span class="n">proposedLength</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">progress</span> <span class="o">+=</span> <span class="n">details</span><span class="p">.</span><span class="n">proposedLength</span><span class="p">();</span>
        <span class="c1">//note: set length to 0 to stop speaking
</span>    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span> <span class="n">music</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">musicLength</span><span class="p">;</span>
<span class="p">};</span>
</code></pre><pre class="highlight cpp tab-cpp"><code><span class="k">struct</span> <span class="n">SquareWave</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AudioSource</span><span class="o">&lt;</span><span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AUDIO_VECTOR</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">SquareWave</span><span class="p">()</span> <span class="o">:</span> <span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AudioSource</span><span class="o">&lt;</span><span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AUDIO_VECTOR</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">sampleOffset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span> <span class="n">read</span><span class="p">(</span><span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">AudioTransmissionDetails</span><span class="o">&amp;</span> <span class="n">details</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span> <span class="n">target</span><span class="p">(</span><span class="n">details</span><span class="p">.</span><span class="n">proposedLength</span><span class="p">());</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int16_t</span><span class="o">&amp;</span> <span class="n">sample</span> <span class="o">:</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//2000 is the volume
</span>                <span class="c1">//100 is how long half the square wave is
</span>                <span class="n">sample</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">sampleOffset</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">2000</span> <span class="o">:</span> <span class="o">-</span><span class="mi">2000</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">target</span><span class="p">;</span>
        <span class="c1">//note: return vector with a size of 0 to stop speaking
</span>    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">sampleOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</code></pre>
<p>Creating an AudioSource is done by creating a class that inherits a type of AudioSource and filling in the virtual function, <code class="prettyprint">read</code>.</p>

<p>This read function should, by default, output PCM stereo audio samples at 48000 Hz with the 2 channels interleaved.
If you aren&rsquo;t familiar with digital audio samples, <a href="http://manual.audacityteam.org/man/digital_audio.html">here&rsquo;s a good article about it</a>.
In the <code class="prettyprint">read</code> function, you&rsquo;ll be given a <code class="prettyprint">SleepyDiscord::AudioTransmissionDetails</code>, this will give details about what audio settings to use and some other stuff like how much audio has been sent since last time.
Don&rsquo;t worry about calling read, the library will instead call <code class="prettyprint">read</code> when audio data is needed while sending audio.</p>

<blockquote>
<p>You can also send Opus encoded audio instead of PMC audio
<code class="prettyprint">cpp
struct Music : public SleepyDiscord::AudioSource&lt;SleepyDiscord::AUDIO_POINTER&gt; {
    constexpr inline bool isOpusEncoded() { return true; }
}
</code></p>
</blockquote>

<p>As of when this was written, there are two types of <a href="documentation.html#audiosource">AudioSources</a>, AUDIO_POINTER and AUDIO_VECTOR. They differ in their read function.</p>

<h4 id="audio_pointer">AUDIO_POINTER</h4>

<p><code class="prettyprint">read</code> points a pointer to a buffer of audio data and sets the length.</p>

<h4 id="audio_vector">AUDIO_VECTOR</h4>

<p><code class="prettyprint">read</code> returns a vector of audio data</p>

<aside class="note">
The sizes of audio buffers should 960. Which is .02 seconds of 48kHz stereo audio.
</aside>

<h3 id="speak">Speak</h3>
<pre class="highlight cpp tab-cpp"><code><span class="c1">//In your VoiceEventHandler
</span><span class="kt">void</span> <span class="nf">onReady</span><span class="p">(</span><span class="n">SleepyDiscord</span><span class="o">::</span><span class="n">VoiceConnection</span><span class="o">&amp;</span> <span class="n">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">connection</span><span class="p">.</span><span class="n">startSpeaking</span><span class="o">&lt;</span><span class="n">SquareWave</span><span class="o">&gt;</span><span class="p">(</span><span class="cm">/*Parameters to pass over to SquareWave's constructor*/</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
<p>To start speaking, call <a href="documentation.html#startspeaking">VoiceConnection::startSpeaking</a> with your AudioSource as the template parameter. To stop, send a buffer with the length of zero in your AudioSource&rsquo;s read function. If your AudioSource has any parameters in it&rsquo;s constructor, you pass them to this function.</p>

<h4 id="related-articles">Related Articles</h4>

<p><a href="documentation.html#audiosource">AudioSource</a>
<a href="documentation.html#startspeaking">VoiceConnection::startSpeaking</a></p>

<h2 id="receiving-audio">Receiving Audio</h2>

<p>Not implemented yet.</p>

      </div>
      <div class="dark-box">
      </div>
    </div>
    </section>
  </body>
</html>
